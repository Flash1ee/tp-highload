# Курс "Проектирование высоконагруженных систем"

**Тема курсовой работы:**  
Проектирование сервиса видеозвонков *Zoom*

## Введение в предметую область

[Zoom](https://ru.wikipedia.org/wiki/Zoom_(%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B0)) - проприетарная программа для организации видеоконференций, разработанная компанией Zoom Video Communications. Она предоставляет сервис видеотелефонии, который позволяет подключать одновременно до 100 устройств бесплатно, с 40-минутным ограничением для бесплатных аккаунтов.

В работе акцент будет сосредоточен на возможностях создания видеоконференций.

## Целевая аудитория

На декабрь 2020 года [[1.1]](#source-1) в ежедневных видеовстречах принимали участие около 350 миллионов пользователей.  
В 2021 году месячная аудитория сайта `zoom.us` в России была около 23 миллионов пользователей [[1.2]](#source-1).

Учитывая статистику 2020 года и то, что в СНГ приблизительно 2% пользователей `Zoom` можно высчитать, что количество пользователей = `350 * 0.02 ~= 7 млн.`.  
Это число показывает ежедневную аудиторию сервиса, однако, это не уникальные инспользования. Один человек может несколько раз участвовать в конференции.  
Пусть каждый человек в среднем делает по 3 звонка. Тогда `7 / 3 ~= 2 млн` => в СНГ ежедневная нагрузка сервиса может достигать 2 млн пользователей.  

Таким образом, целевая аудитория для проектируемого сервиса следующая:
- Страны СНГ;
- Пользователи в возрасте 18 - 50 лет;

Сводная таблица:  
| Месячная аудитория в СНГ | Еждневная нагрузка (кол-во сессий) | Дневная нагрузка по пользователям |
|--------------------------|------------------------------------|-----------------------------------|
| 23 млн                    | 7 млн                              | 2 млн                             |

### MVP
- Создание аккаунта, авторизация.
- Присоединиться к конференции.
- Создание видеоконференций:
  - Максимальное число участников - 50 человек.
  - Возможность приглашать/исключать участников.
  - Сохранение записей конференций.
  - Чат.
## Расчет нагрузки

### Продуктовые метрики
- Месячная аудитория - `23 млн.` чел.
- Дневная аудитория - `2 млн.` чел.
- Средний размер хранилища пользователя:
  - Хранение данных аккаунта `1 МБ` - фото пользователя, персональная информация.
  - Хранение записей видеозвонков (20% пользователей): ориентируемся, что пользователь сохраняет `5 часов` видео в месяц в хранилище сервиса. `1 час` видео в формате `HD` весит около `1 ГБ`, следовательно, за месяц пользователь тратит `5 ГБ`, за год `60 ГБ`.  
  - Хранение информации о запланированных конференциях:
   - 1 запись из `500 символов`, т.е `500 Б` * `8 Б` = `4000 Б`
- Среднее количество действий пользователя по типам за период (день)
1. **Регистрация / авторизация.**
В месяц пользователь 10 раз создает аккаунт или входит в него -> 0.33 действий в день.

2. **Создание конференции**
В среднем за месяц пользователь создает 30 конференций -> 30/30 = 1 создание в день.

3. **Участие в конференции (как участник)**
В среднем за месяц пользователь участвует в 60 конференциях -> 60/30 = 2 участия в день.

4. **Редактирование профиля**
В среднем пользователь редактирует свои данные 3 раза в месяц -> 3/30 = 0.1 редактирование в день

5. **Сохранение видеозаписи конференции**
В среднем пользователь сохраняет 5 записей в месяц -> 5/30 = 0.16 сохранений в день

6. **Отправка сообщений в чат**
В среднем пользователь отправляет 10 сообщений за конференцию -> 2 * 10 = 20 сообщений в день

**Сводная таблица**

**Итого**

| Регистрация и авторизация | Создание конференции | Участие в конференции | Редактирование профиля | Сохранение записи |  Отправка сообщений |
|---------------------------|----------------------|-----------------------|------------------------|-------------------|--------------------|
| 0.33                         | 1                  | 2                  | 0.1                    | 0.16              |20          |

#### Оценка аудитории

**Для СНГ**
- Дневная аудитория
    - Около `2 млн` человек уникальных пользователей
- Месячная аудитория
  - Desktop `24 миллиона` пользователей
### Технические метрики

**Замечания**

Пусть:
- в 1 конференции чат содержит в среднем `25000` символов или `4250` слов (примерно 10 страниц А4 12 шрифтом).
- строки хранятся в `utf-8` => `1 символ` занимает `8 байт`.
- в 1 сообщении `25 символов`.
- считаем, что сервисом польлзуется `25 миллионов` пользователей.
- одна сессия занимает `16` + `8 байт` = `24 байта` (sessionID, userID)
- хранилище звонков (информация об участниках конференции) - `32 байта` на запись.
- пользователь в среднем `60 %` времени конференции использует видеокамеру и `30 %` времени аудио
- средняя длительность `1` звонка = `54` минуты [[1.4]](#source-4), округлим до `1` часа

**Размер хранения**

  - Персональные данные (профиль) = `25.000.000` * `1Мб` = `23.84 Тб`
  - Записи конференций = `5 Гб` * `12 мес` * `25.000.000` = `4 394 531` ~= `1.5`миллионов Тб за год
  - Записи чатов = `25.000.000` * `2`(кол-во конференций в день) * `365` *  `25 000` * `8` * = `3318` ТБ за год
  - Хранилище сессий: `2 000 000` * `24` * `2` * `0.5` = `46` МБ.
  - Хранилища звонков: `2 000 000` × (`32 байта` * `2`) * `365` = `44 ГБ` в год.

**Сетевой трафик (по существенным типам)**

- По данным официального сайта Zoom [[1.5]](#source-5), для HD видео пропускная способность должна быть 1.8 МБит/с на загрузку, FULL HD - 3 МБит/с -> возьмем среднее (1.8 + 3) / 2 = 2.4 Мбит/с на пользователя
- 1 конференция длится 1 час -> пропускная способность на пользователя 2.4 * 3600 = 8640 Мбит/час = 8.64 ГБит/час
- Для всех пользователей: `8.64` *` 2 000 000` * `0.6` {60% времени используется видео} = `10 368 000` ГБит/ч
- Передача аудио = `16` Кбит/с * `10^(-6)` * `2 000 000` * `3600` * `0.3` = `34560` Гбит/ч
- Сохранение записи в облаке: По данным официального сайта Zoom [[1.5]](#source-5), на HD видео скорость выгрузки должна быть не менее 1.2 МБ/с
      - Для всех пользователей: `1.25` Мбит/с * `10^-3` * `2 000 000` * `0.16` = `400` Гбит/ч
**Сетевой трафик при пике нагрузки**

- Предположим, что в пиковый час нагрузка составляет 30% от дневной нагрузки, т.е. `600` тысяч человек.  
- 80 % времени используется видео и звук.
- Пиковая нагрузка: `8.64` * `600 000 * 2ч / 24ч` * `0.8` + `16` Кбит/с * `10^(-6)` * `600 000 * 2ч / 24ч` * `3600` * `0.6` + `1.25` Мбит/с * `10^-3` * `600 000 * 2ч / 24ч` * `0.16` = `4.18` * `10^5` ГБит/ч = `117` ГБит/с


- **RPS в разбивке по типам запросов**

RPS можно посчитать по формуле: {число заходов на страницу одного человек} * 2 000 000 { число пользователь в день } / 24 / 60 / 60
- Регистрация и авторизация: `2 000 000` * `0.33` / 24 / 60 / 60 = 8 rps
- Создание и удаление конференции: `2 000 000` * `1` * 2 / 24 / 60 / 60 = 46 rps
- Участие в конференции: `2 000 000` * `2` * (`2` {получение звука и видео}) * `2` {присоединение, отсоединение} / 24 / 60 / 60 = 368 rps
- Редактирование профиля: `2 000 000` * `0.1` / 24 / 60 / 60 = 2.3 rps
- Сохранение видеозаписи: `2 000 000` * `0.16` / 24 / 60 / 60 = 3.7 rps
- Отправка сообщений в чат: `2 000 000` * `20` / 24 / 60 / 60 = 460 rps

Суммарно: `888 RPS`


## Логическая схема базы данных

![Highload zoom](https://user-images.githubusercontent.com/55987935/171964769-b5044052-653e-493a-b948-58eb27e1cbf0.png)

## Физическая схема
Для сессий авторизации требуется быстрое для создания/получения хранилище. Для хранения подойдет Redis/Tarantool.  

Хранение данных о пользователе, чатах. конференциях организуется с использованием PostgreSQL.

Для записей конференций будут использоваться сервера с большим объемом памяти, доступной для долговременного хранения(HDD).  

## Технологии

### Бэкенд

Для сервиса подходит ***микросервисная архитектура***. 

Микросервисная архитектура позволяет:  
- разделить разработку между командами разработчиков, которые независимо смогут вести разработку (эффективность);
- повысить отказоустойчивость системы;
- добавить возможность горизонтального масштабирования.  


Для взаимодействия сервисом будем использовать протокол **grpc**, т.к. он является быстрым бинарным протоколом, с жёстким API взаимодействия.  

Выделяется 2 сервиса: 
- авторизация и регистрация;
- звонки. 

Сервис звонков делится на 3 сервиса: 
- загрузка видео/аудио;
- перекодировка видео;
- раздача видео/аудио.

Для данных сервисов можно использовать язык ***Go*** на основе следующих причин:
* прост и является в настоящее время популярен на рынке;
* имеет множество библиотек упрощающих разработку, в том числе библиотеки для работы с grpc;
* горутины и каналы позволяют эффективно распараллеливать обработку задач.

Для обеспечения общения большого количества человек будет использоваться хост-сервер. 
Общение с ним происходит по протоколу UDP. 
Схема взаимодействия:
- Сервер принимает видео и аудио от каждого участника;
  - если участник может принять HD видео и аудио, ему отправляются необработанные буферы всех участников;
  - если не может (слабый интернет), то сервер раскодирует принятые буферы, перекодирует в низкое качество и отправит.

С целью оптимизации сети можно:
- не получать и/или не отдавать звук, если он ниже определённого порога или если микрофон выключен;
- отдавать видео в качестве пропорциональном размеру его картинки на экране (если видео пользователя развёрнуто на весь экран (например, он сейчас говорит) отдаём его по логике из _Схемы взаимодействия_), если пользователь показан в боковой панеле (маленькое окошко), понижаем качество его видео.

Для видео — H.264. Он поддерживается на 99% устройств, менее требователен к батарее, имеет лучшее качество видео после кодирования и раскодирования, очень высокую степень сжатия. [[2.1]](#source-2.1)


### Фронтенд
Для **фронтенда** можно использовать фреймворки **Vue.JS/React.js**. 
Это одни из самых популярных фреймворков в последние годы. 
Из плюсов можно выделить высокую производительность (основаны на Virtual DOM), переиспользуемость компонентов.

### База данных

* **Для основных данных** следует использовать **PostgreSQL**. Postgres активно развивается в последние годы. Также подходит для текущей нагрузки.
* **Сессии** будут храниться в key-value хранилище, **Redis**. В качестве ключа будет id пользователя, в качестве id сессии - некоторый UUID с присодинениям к нему id пользователя и взятием от него хэша алгоритмом sha3.

Для хранения видео используется **Amazon S3/Физические сервера**.

#### Балансировка нагрузки
Используем Nginx для балансировки нагрузки и в качестве reverse-proxy.

## Схема проекта
<img width="795" alt="zoom-arch" src="https://user-images.githubusercontent.com/55987935/171904655-004f9551-fc7b-431c-a947-943e8e096254.png">

### Тип соединения с приложением
Все вызовы API, вся связь между компонентами и т. д. будут происходить по TCP, но вся передача видео будет происходить по UDP.
## Список серверов

### Сервера для хранения файлов
Хранение и просмотр записей конференций будет осуществляться с помощью физических серверов с большими дисковыми хранилищами. 

Микросервис загрузки видео будет сохранять записи в хранилище и записывать ссылку в БД.

По данным, приведённым выше, файлы занимают примерно 1500 ПБ

#### Географическое распределение

Для ускорения доступа можно сделать реплику хранилища в Азиатской части России. Создавать дополнительные реплики нецелесообразно, т.к. при таком объеме хранилища цена будет очень высокой.  

#### Отказоустойчивость

Репликация в другой регион обеспечит сохранность файлов и возможность переключения на реплику в случае выхода из строя главного хранилища.

В случае полного отказа, основные функции сервиса продолжат работать (но нельзя будет отправить и загрузить файлы)

#### Количество серверов

Основное хранилище в Европе + реплика в Азии

### Сервер с данными (Postgres)

**RAM**
* Необходимо достаточно большое кол-во RAM

**Storage**
* 1 ТБ - размер базы


| Параметр   | Значение |
| :----:     |      :---|
| CPU        | 8 ядер      |
| RAM        | 16 ГБ     |
| Storage    | 1 ТБ (2 RAID1) |

#### Географическое распределение

Сервер с главной БД стоит разместить в Европе, т.к. там наибольшее число пользователей.

#### Отказоустойчивость

В каждом регионе минимум 2 базы, разместим их в разных дата-центрах.

RAID1 защитит от выхода из строя 1 накопителя.

В случае падения "главной" базы данных произойдет переключение на одну из реплик.

#### Количество серверов

2 региона * 2 сервера = **4 сервера**

### Redis

Redis явдяется in-memory хранилищем, следовательно требуется большой объём оперативной памяти.

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 2 |
| RAM (Gb) | 32 |
| HDD (Gb) | 20 |

### Голосовые сервера

**CPU**:
* Перекодирование голоса - требовательная операция к CPU, поэтому необходимо большое кол-во ядер.

**RAM**:
* Перекодирование не требует большого объема RAM

**Storage:**
* Перекодирование не требует большого хранилища

**Network:**
* Общая сетевая нагрузка от голосовых потоков: 9 * 2 = 18 ГБит/с
* Обеспечим запас в 25%: 18 * 0.25 = 4.5 ГБит/с
* Итого: 23 Гбит/c

| Параметр   | Значение |
| :----:     |      :---|
| CPU       | 16 ядер      |
| RAM        | 2 ГБ     |
| Storage    | 40 ГБ    |
| Network    | 10 Гбит/с |

#### Географическое распределение

Сервера можно равномерно распределить по регионам, в зависимости от процента пользователей.

#### Отказоустойчивость

При отказе сервера, микросервис звонков распределит нагрузку на другие сервера.

#### Количество серверов

Нам потребуется 23 / 10 ~= **3 сервера**

### Сервера трансляций (отправка. кодирование. раскодирование)
**CPU**. 

Кодирование голоса и видео - требовательная операция к CPU, поэтому необходимо большое кол-во ядер.
Кодирование вынесем на машины пользователей. 
<!-- 
По бенчмаркам библиотеки для кодирования видеопотоков H.264 - x264 [[3.1]](#source-3-1) 64 ядерный процессор в среднем обрабатывает 200 кадров в секунду видео в формате 1920х1080.  
Максимальное качество видео трансляции - 1920x1080@60, следовательно, для достижения этого показателя достаточно использовать мощности 1/3 процессора (с запасом).  
 -->
Тогда, на 1 пользователя требуется 1 поток на отправку и прием (можно запускать в горутинах), 1 поток на декодирование.
В пике 600 000 пользователей => `2 * 600 000` = `1 200 000 потоков`
На сервер с 64 ядрами(х2), уйдет `1 200 000 / (64 * 2)` = `9 375 серверов`

**RAM**. 

Перекодирование не требует большого объема RAM. 

**Storage**

Перекодирование не требует большого хранилища. 

| Параметр   | Значение |
| :----:     |      :---|
| CPU       | 64(x2) ядра  |
| RAM        | 4 ГБ |
| Storage    | 20 ГБ |

#### Географическое распределение

Сервера можно равномерно распределить по регионам, в зависимости от процента пользователей.

#### Отказоустойчивость

При отказе сервера, микросервис трансляций распределит нагрузку на другие сервера.

#### Количество серверов

Нам потребуется =**18 750 серверов**

### Nginx

**CPU:**
* 888 RPS
* 2-х ядер [хватит](https://www.nginx.com/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers/)

**Network**
Расчитаем конфигурацию согласно самому нагруженному, т.е. 20% от нагрузки, с запасом будет 25%.

Пиковая нагрузка - 117 ГБит/с

117 Гбит/c / 2 регионов = 58,5 Гбит/с на регион 

| Параметр   | Значение |
| :----:     |      :---|
| CPU        | 2 ядра |
| RAM        | 2 ГБ  |
| Storage    | 40 ГБ  |
| Network    | 2 Гбит/с |

Нагрузка между серверами будет балансироваться с помощью Cloudflare DNS load balancing.

#### Географическое распределение

В каждом регионе по 30 серверов, подходящий сервер будет выбираться DNS балансером.

На регион по 30 серверов.  

#### Отказоустойчивость

30 серверов в каждом регионе, можно разделить их на 2 дата-центра.

[Health monitoring](https://www.cloudflare.com/load-balancing/) серверов, прекращение нагрузки на отказавший сервер.

#### Количество серверов

30 * 2 = **60 серверов**

### Микросервисы

Данные сервера подвергаются сравнительно небольшой нагрузке и не требуют больших ресурсов.

| Параметр   | Значение |
| :----:     |      :---|
| CPU        | 2 ядра |
| RAM        | 2 ГБ  |
| Storage    | 40 ГБ  |
| Network    | 100 Мбит/с / 40 Гбит/с|

_Серверу звонков необходимо 40 Гбит/с пропускной способности, т.к. через него будут проходить видео потоки и файлы_

#### Географическое распределение

Разместим в каждом регионе по 2 сервера на каждый микросервис и увеличим кол-во по мере необходимости. 

Нагрузка в регионе будет распределяться с помощью nginx.

#### Отказоустойчивость

Размещение в 2-х дата-центрах.

nginx перестанет направлять запросы на отказавший сервер.

#### Количество серверов

5 микросервисов * 2 * 2 региона = 20 серверов
### Сводная таблица

| Сервер                 | Всего |
| :----:                 | :----: 
| **Postgres**           | 4   |
| **Голосовые сервера**  | 4  | 
| **Сервера трансляций** | 9375 |
| **Redis**  | 2  | 
| **Nginx**              | 60  | 
| **Микросервисы**       | 20   | 

## Использованные источники
1. Статистические данные
    1. <a id="source-1"></a>[Статистические данные по zoom декабрь 2020](https://www.businessofapps.com/data/zoom-statistics/)
    2. <a id="source-2"></a>[Месячная статистика помещаемости в РФ](https://www.statista.com/statistics/1117659/average-traffic-on-remote-working-platforms-in-russia/)
    3. <a id="source-3"></a>[Статистические данные по zoom](https://backlinko.com/zoom-users)
    4. <a id="source-4"></a>[Данные по использованию Zoom в 2021](https://blog.zoom.us/how-you-zoomed-over-the-past-year-2021/)
2. Предметная область
    1. <a id="source-2.1"></a>[H264](https://medium.com/@brandonaaskov/vp8-vs-h-264-originally-written-posted-on-may-19-2014-3b432d58abaa)
3. Список серверов
    1. <a id="source-2.1"></a>[x264 бенчмарки](https://openbenchmarking.org/test/pts/x264)
